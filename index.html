<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Battle Frontier - Gen 3</title>
    <script src="Scripts/jquery-2.1.0.min.js"></script>
    <script src="Scripts/move_data.js"></script>
    <script src="Scripts/pokedex.js"></script>
    <script src="Scripts/type_data.js"></script>
    <script src="Scripts/stat_data.js"></script>
    <script src="Scripts/nature_data.js"></script>
    <script src="Scripts/item_data.js"></script>
    <script src="Scripts/damage_gen3.js"></script>
    <script src="Scripts/setdex_gen3_sets.js"></script>
    <script src="Scripts/ability_descriptions.js"></script>
    <script src="Scripts/learnsets.js"></script>
    <script src="Scripts/factory.js"></script>
    <script type="module">
        // import the ES module that exports SPECIES_NATIONAL and expose it as a global
        import { SPECIES_NATIONAL } from './Pok√©monNationalDexNr.js';
        window.SPECIES_NATIONAL = SPECIES_NATIONAL;
    </script>
</head>
<body>
    <style>
        :root {
            --bg: #f4efe6;
            --ink: #1e1a16;
            --accent: #d26a2f;
            --accent-2: #2a7f62;
            --paper: #fff8ee;
            --muted: #6d5c4b;
            --ohko-you: #c6eabc;
            --ohko-them: #f5b8b1;
            --maybe-ohko-you: #e9f6e9;
            --maybe-ohko-them: #fde7e5;
            --neutral: #ffffff;
            --border: #d9c9b8;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: Consolas, "Courier New", monospace;
            font-size: 13px;
            color: var(--ink);
            background: var(--bg);
        }
        header {
            padding: 12px 16px;
            background: linear-gradient(90deg, #1a6b3c 0%, #228b4a 30%, #2ea55e 60%, #3cc76e 100%);
            border-bottom: 2px solid #145a30;
            color: #fff;
        }
        header h1 { margin: 0; font-size: 18px; font-weight: 700; }

        /* ---- Setup panel ---- */
        .setup-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px 16px;
            background: var(--paper);
            border-bottom: 1px solid var(--border);
            align-items: flex-end;
        }
        .setup-bar label { display: flex; flex-direction: column; font-size: 11px; color: var(--muted); }
        .setup-bar input, .setup-bar select { font-family: inherit; font-size: 13px; padding: 3px 5px; border: 1px solid var(--border); border-radius: 4px; background: #fff; }
        .setup-bar select { max-width: 155px; }
        .setup-bar input[type="number"] { width: 52px; }
        .setup-bar .ev-group { display: flex; gap: 4px; }
        .setup-bar .ev-group label { min-width: 38px; }
        .setup-bar button {
            padding: 5px 14px;
            border: 0; border-radius: 6px;
            color: #fff;
            background: linear-gradient(90deg, var(--accent), #f39d5a);
            cursor: pointer;
            font-weight: 700;
            font-size: 13px;
        }
        .statbox {
            font-size: 12px;
            background: #f3eadf;
            border: 1px dashed var(--border);
            padding: 6px 10px;
            border-radius: 6px;
            white-space: pre-wrap;
            margin: 6px 16px;
        }
        /* ---- Filter bar ---- */
        .filter-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            padding: 8px 16px;
            background: #fffdf9;
            border-bottom: 1px solid var(--border);
            align-items: center;
            font-size: 12px;
        }
        .filter-bar label { display: flex; align-items: center; gap: 4px; color: var(--muted); }
        .filter-bar select, .filter-bar input { font-family: inherit; font-size: 12px; padding: 2px 5px; border: 1px solid var(--border); border-radius: 4px; background: #fff; }
        .filter-bar input[type="number"] { width: 55px; }
        .filter-bar input[type="text"] { width: 110px; }
        #status { color: var(--accent); font-weight: 600; margin-left: auto; }

        /* ---- Spreadsheet table ---- */
        .table-wrap {
            overflow: auto;
            padding: 0 16px 20px 16px;
        }
        #results {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        #results th {
            position: sticky;
            top: 0;
            background: #eee5d8;
            border: 1px solid var(--border);
            padding: 3px 4px;
            text-align: left;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
            font-size: 10px;
            color: var(--muted);
        }
        #results th:hover { background: #e0d4c3; }
        #results th .arrow { font-size: 8px; margin-left: 1px; }
        #results td {
            border: 1px solid var(--border);
            padding: 2px 3px;
            white-space: nowrap;
            vertical-align: middle;
            font-size: 11px;
        }
        /* make the first column a fixed square for sprites */
        #results td:first-child, #results th[data-col="species"] {
            width: 44px;
            text-align: center;
            padding: 6px;
        }
        #results td img.sprite {
            width: 32px;
            height: 32px;
            object-fit: contain;
            display: block;
            margin: 0 auto;
            image-rendering: auto;
        }
        /* EV grid (six small stat boxes) */
        .ev-grid { display:flex; gap:2px; align-items:stretch; }
        .ev-cell { min-width:24px; padding:2px 3px; border-radius:3px; text-align:center; font-size:10px; background:transparent; border:1px solid transparent; }
        .ev-cell span.label { display:block; font-size:9px; color:var(--muted); }
        /* per-cell OHKO coloring */
        .dmg-you.ohko { background: var(--ohko-you); }
        .dmg-them.ohko { background: var(--ohko-them); }
        /* possible (but not guaranteed) OHKO */
        .dmg-you.maybe-ohko { background: var(--maybe-ohko-you); }
        .dmg-them.maybe-ohko { background: var(--maybe-ohko-them); }
        #results tr:hover td { filter: brightness(0.96); }
        /* move label tiles colored by type */
        .move-label { display:inline-block; padding:1px 3px; border-radius:3px; margin:1px 1px; font-size:10px; color:#000; cursor:pointer; }
        /* ability label styles */
        .ability-label { display:inline-block; padding:1px 4px; border-radius:3px; font-size:10px; color:var(--ink); background:#eee5d8; cursor:default; position:relative; }
        .ability-label.clickable { cursor:pointer; }
        .ability-label.clickable:hover { outline:2px solid var(--accent); }
        .ability-label.ability-active { background:var(--accent); color:#fff; font-weight:600; }
        .ability-label.ability-inactive { opacity:0.5; }
        .ability-sep { font-size:10px; color:var(--muted); margin:0 1px; }
        /* ability tooltip */
        .ability-tip { position:absolute; bottom:100%; left:50%; transform:translateX(-50%); background:#333; color:#fff; font-size:11px; padding:4px 8px; border-radius:4px; white-space:nowrap; z-index:100; pointer-events:none; margin-bottom:4px; display:none; }
        .ability-label:hover .ability-tip { display:block; }
        .move-label:hover { outline:2px solid var(--accent); }
        .move-label.filter-active { outline:2px solid var(--accent); box-shadow:0 0 4px var(--accent); }
        /* clickable item & nature cells */
        td.clickable-item, td.clickable-nature { cursor:pointer; }
        td.clickable-item:hover, td.clickable-nature:hover { outline:2px solid var(--accent); outline-offset:-2px; }
        td.clickable-item.filter-active, td.clickable-nature.filter-active { outline:2px solid var(--accent); outline-offset:-2px; box-shadow:inset 0 0 4px rgba(210,106,47,0.25); }
        /* active-filter indicator bar */
        #activeFilters { display:none; flex-wrap:wrap; gap:6px; padding:6px 16px; background:#fff3e6; border-bottom:1px solid var(--border); font-size:12px; align-items:center; }
        #activeFilters.visible { display:flex; }
        .af-tag { display:inline-flex; align-items:center; gap:4px; padding:2px 8px; border-radius:12px; background:var(--accent); color:#fff; font-weight:600; font-size:11px; cursor:pointer; }
        .af-tag:hover { filter:brightness(0.85); }
        .af-tag .af-x { font-weight:700; margin-left:2px; }
        /* team card styles */
        #teamContainer { padding: 6px 16px; background: var(--paper); border-bottom: 1px solid var(--border); }
        .team-card {
            display: flex; flex-wrap: wrap; gap: 6px; align-items: flex-end;
            padding: 8px 16px; margin-bottom: 6px;
            background: #fff; border: 1px solid var(--border); border-radius: 6px;
        }
        .team-card label { display: flex; flex-direction: column; font-size: 10px; color: var(--muted); }
        .team-card input, .team-card select { font-family: inherit; font-size: 12px; padding: 2px 4px; border: 1px solid var(--border); border-radius: 4px; background: #fff; }
        .team-card select { max-width: 140px; }
        .team-card input[type="number"] { width: 46px; }
        .team-card .ev-group { display: flex; gap: 3px; }
        .team-card .ev-group label { min-width: 32px; }
        /* top row: card number, import, remove */
        .tc-top-row { display:flex; align-items:center; gap:6px; width:100%; margin-bottom:2px; }
        /* stat grid: header + EVs + IVs in columns */
        .stat-grid { display:grid; grid-template-columns:auto repeat(6,1fr); gap:2px 4px; align-items:center; font-size:11px; }
        .stat-grid .sg-label { font-weight:700; color:var(--muted); font-size:10px; text-align:center; }
        .stat-grid .sg-row-label { font-weight:700; color:var(--muted); font-size:10px; text-align:right; padding-right:4px; }
        .stat-grid input[type="number"] { width:42px; font-size:11px; padding:1px 3px; text-align:center; }
        .tc-species-wrap { display:flex; align-items:flex-end; gap:12px; position:relative; }
        .tc-sprite { width:48px; height:48px; object-fit:contain; display:block; image-rendering: auto; align-self:center; }
        /* custom species autocomplete dropdown */
        .sp-dropdown { position:absolute; top:100%; left:0; z-index:100; background:#fff; border:1px solid var(--border); border-top:0; border-radius:0 0 6px 6px; max-height:200px; overflow-y:auto; width:160px; box-shadow:0 4px 10px rgba(0,0,0,0.12); display:none; }
        .sp-dropdown.open { display:block; }
        .sp-dropdown .sp-opt { padding:3px 8px; cursor:pointer; font-size:12px; font-family:inherit; }
        .sp-dropdown .sp-opt:hover, .sp-dropdown .sp-opt.highlighted { background:#e8f4ec; }
        .sp-dropdown .sp-opt.selected { background:var(--accent-2); color:#fff; }
        .team-card .card-num { font-weight: 700; font-size: 13px; color: var(--accent); margin-right: 4px; align-self: center; }
        .remove-btn { border:0; background:transparent; color:#c44; font-size:16px; cursor:pointer; align-self:center; padding:2px 6px; }
        .remove-btn:hover { color:#a00; }
        .import-btn { border:0; background:var(--accent-2); color:#fff; font-size:11px; font-weight:600; cursor:pointer; padding:3px 10px; border-radius:4px; }
        .import-btn:hover { filter:brightness(1.15); }
        .import-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); display:flex; align-items:center; justify-content:center; z-index:9999; }
        .import-dialog { background:var(--paper); border:2px solid var(--border); border-radius:8px; padding:16px; width:360px; max-width:90%; box-shadow:0 4px 20px rgba(0,0,0,0.3); }
        .import-dialog h3 { margin:0 0 8px; font-size:14px; color:var(--accent); }
        .import-dialog textarea { width:100%; height:180px; font-family:Consolas,"Courier New",monospace; font-size:12px; border:1px solid var(--border); border-radius:4px; padding:6px; resize:vertical; }
        .import-dialog .btn-row { display:flex; gap:8px; margin-top:10px; justify-content:flex-end; }
        .import-dialog button { padding:5px 14px; border:0; border-radius:6px; cursor:pointer; font-weight:700; font-size:12px; }
        .import-dialog .import-ok { background:linear-gradient(90deg,var(--accent-2),#3cc76e); color:#fff; }
        .import-dialog .import-cancel { background:#ddd; color:#333; }
        .team-actions { padding: 6px 16px; background: var(--paper); border-bottom: 1px solid var(--border); display:flex; gap:10px; align-items:center; }
        .add-btn { border:0; background:var(--accent-2); color:#fff; font-size:18px; font-weight:700; width:32px; height:32px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; }
        .add-btn:hover { filter:brightness(1.1); }
        /* compact combined cells for member matchups */
        .matchup-cell { display:flex; flex-direction:column; gap:1px; }
        .matchup-cell .mc-move { font-size:10px; }
        .matchup-cell .mc-dmg { font-size:11px; font-weight:600; }
        .matchup-cell .mc-spd { font-size:9px; font-weight:700; padding:1px 3px; border-radius:3px; display:inline-block; }
        .mc-spd.fast { background:#c6eabc; color:#1a6b3c; }
        .mc-spd.slow { background:#f5b8b1; color:#a33; }
        /* boost controls */
        .boost-group { display:flex; gap:2px; align-items:flex-end; margin-left:2px; }
        .boost-group label { display:flex; flex-direction:column; font-size:9px; color:var(--muted); align-items:center; min-width:28px; }
        .boost-group select { width:34px; font-size:10px; padding:1px; border:1px solid var(--border); border-radius:3px; text-align:center; }
        .type-fire{background:#ffb3b3}
        .type-water{background:#b3d8ff}
        .type-grass{background:#c8f0c8}
        .type-electric{background:#fff6b3}
        .type-rock{background:#d9c7b3}
        .type-ground{background:#f0d6b3}
        .type-psychic{background:#f2c8ff}
        .type-ghost{background:#d6c8ff}
        .type-dark{background:#d0c6c0}
        .type-ice{background:#dff0ff}
        .type-dragon{background:#c7d7ff}
        .type-normal{background:#e8e8e8}
        .type-steel{background:#d6dbe0}
        .type-flying{background:#e6f0ff}
        .type-bug{background:#e6f7d6}
        .type-poison{background:#e9d6ff}
        .type-fighting{background:#ffd6c0}
        /* item sprite next to item name */
        .item-sprite {
            width: 20px;
            height: 20px;
            object-fit: contain;
            vertical-align: middle;
            margin-right: 3px;
            image-rendering: auto;
        }
    </style>

    <header>
        <h1>Battle Frontier Team Builder - Emerald</h1>
    </header>

    <div id="teamContainer"></div>
    <div class="team-actions">
        <button class="add-btn" id="addMember">+</button>
        <button id="calc" style="padding:5px 14px;border:0;border-radius:6px;color:#fff;background:linear-gradient(90deg,var(--accent),#f39d5a);cursor:pointer;font-weight:700;font-size:13px;">Calculate</button>
    </div>
    <div id="computed" class="statbox" style="display:none"></div>

    <div class="filter-bar">
        <label>Pool:
            <select id="poolFilter">
                <option value="group1">Group 1</option>
                <option value="group2">Group 2</option>
                <option value="group3" selected>Group 3</option>
                <option value="frontier_brains">Frontier Brains</option>
                <option value="all">All</option>
            </select>
        </label>
        <label>Weather:
            <select id="weatherSelect">
                <option value="">(None)</option>
                <option value="Sun">Sun</option>
                <option value="Rain">Rain</option>
                <option value="Sand">Sand</option>
                <option value="Hail">Hail</option>
            </select>
        </label>
        <label style="display:flex;align-items:center;gap:4px"><input id="teamReflect" type="checkbox">Team Reflect</label>
        <label style="display:flex;align-items:center;gap:4px"><input id="teamLightScreen" type="checkbox">Team L-Screen</label>
        <label style="display:flex;align-items:center;gap:4px"><input id="oppReflect" type="checkbox">Opp Reflect</label>
        <label style="display:flex;align-items:center;gap:4px"><input id="oppLightScreen" type="checkbox">Opp L-Screen</label>
        <!-- Sort and Show controls removed per request -->
        <label>Opp Level: <input id="oppLevel" type="number" value="50" min="1" style="width:70px"></label>
        <label style="display:flex;align-items:center;gap:6px"><input id="oppAuto" type="checkbox" checked>Auto (use your level if &gt;50)</label>
        <label>Search: <input id="nameFilter" type="text" placeholder="e.g. Tyranitar"></label>
        <span id="status"></span>
    </div>
    <div id="activeFilters"></div>

    <div class="table-wrap">
        <table id="results">
            <thead><tr></tr></thead>
            <tbody></tbody>
        </table>
    </div>
    <script>
        /* ==== Hidden Power IV spreads for 70 BP in Gen 3 ==== */
        var HP_TYPE_IVS = {
            'Bug':      {hp:31,at:31,df:31,sa:31,sd:30,sp:30},
            'Dark':     {hp:31,at:31,df:31,sa:31,sd:31,sp:31},
            'Dragon':   {hp:30,at:31,df:31,sa:31,sd:31,sp:31},
            'Electric': {hp:31,at:31,df:31,sa:30,sd:31,sp:31},
            'Fighting': {hp:31,at:31,df:30,sa:30,sd:30,sp:30},
            'Fire':     {hp:31,at:30,df:31,sa:30,sd:31,sp:30},
            'Flying':   {hp:31,at:31,df:31,sa:30,sd:30,sp:30},
            'Ghost':    {hp:31,at:30,df:31,sa:31,sd:30,sp:31},
            'Grass':    {hp:30,at:31,df:31,sa:30,sd:31,sp:31},
            'Ground':   {hp:31,at:31,df:31,sa:30,sd:30,sp:31},
            'Ice':      {hp:31,at:31,df:31,sa:31,sd:31,sp:30},
            'Poison':   {hp:31,at:31,df:30,sa:30,sd:30,sp:31},
            'Psychic':  {hp:30,at:31,df:31,sa:31,sd:31,sp:30},
            'Rock':     {hp:31,at:31,df:30,sa:31,sd:30,sp:30},
            'Steel':    {hp:31,at:31,df:31,sa:31,sd:30,sp:31},
            'Water':    {hp:31,at:31,df:31,sa:30,sd:31,sp:30}
        };
        var HP_TYPES = ['Bug','Dark','Dragon','Electric','Fighting','Fire','Flying','Ghost','Grass','Ground','Ice','Poison','Psychic','Rock','Steel','Water'];

        /* ==== cached option HTML (built once at init) ==== */
        var __speciesOpts = '', __moveOpts = '', __natureOpts = '', __itemOpts = '';

        /* ==== click-to-filter state ==== */
        var __clickFilters = { move: null, item: null, nature: null };
        function toggleClickFilter(type, value) {
            if (__clickFilters[type] === value) __clickFilters[type] = null;
            else __clickFilters[type] = value;
            updateActiveFilterBar();
            renderResults(window.__lastResults || []);
        }
        function clearClickFilter(type) {
            __clickFilters[type] = null;
            updateActiveFilterBar();
            renderResults(window.__lastResults || []);
        }
        function updateActiveFilterBar() {
            var bar = $('#activeFilters').empty();
            var any = false;
            var labels = { move: 'Move', item: 'Item', nature: 'Nature' };
            ['move','item','nature'].forEach(function(k) {
                if (__clickFilters[k]) {
                    any = true;
                    var tag = $('<span>').addClass('af-tag').text(labels[k] + ': ' + __clickFilters[k]);
                    tag.append($('<span>').addClass('af-x').html('&times;'));
                    tag.click(function(){ clearClickFilter(k); });
                    bar.append(tag);
                }
            });
            bar.toggleClass('visible', any);
        }
        function applyClickFilters(list) {
            // partition: matching items first, rest after, preserving relative order
            var m = __clickFilters.move, it = __clickFilters.item, n = __clickFilters.nature;
            if (!m && !it && !n) return list;
            var top = [], rest = [];
            list.forEach(function(r) {
                var match = true;
                if (m && !(r.set.moves || []).some(function(mv){ return mv === m; })) match = false;
                if (it && (r.set.item || '') !== it) match = false;
                if (n && (r.set.nature || '') !== n) match = false;
                if (match) top.push(r); else rest.push(r);
            });
            return top.concat(rest);
        }

        /* ==== recalc a single result row with a chosen ability ==== */
        function recalcRowWithAbility(r) {
            var team = window.__team;
            if (!team || !team.length) return;
            var oppLevel = 50;
            if ($('#oppAuto').is(':checked')) {
                var maxLv = Math.max.apply(null, team.map(function(t){ return t.level||50; }));
                oppLevel = Math.max(50, maxLv);
            } else {
                oppLevel = parseInt($('#oppLevel').val()) || 50;
            }
            var defInput = Object.assign({species: r.species, level: oppLevel}, r.set);
            if (r.__chosenAbility) defInput.ability = r.__chosenAbility;
            else {
                var pdx = (typeof pokedex !== 'undefined') ? pokedex : (typeof POKEDEX_ADV !== 'undefined' ? POKEDEX_ADV : {});
                var e = pdx[r.species];
                var abils = (e && e.abilities) ? e.abilities : [];
                if (abils.length === 1) defInput.ability = abils[0];
                else defInput.ability = ''; // dual, none chosen => no ability
            }
            var def = buildPoke(defInput);
            var fields = buildFieldsFromUI();
            var members = [];
            for (var ti = 0; ti < team.length; ti++) {
                var atk = team[ti];
                var forward = calcGen3Matchup(atk, def, {field: fields.fieldForward});
                var reverse = calcGen3Matchup(def, atk, {field: fields.fieldReverse});
                var atkBestMove = '', atkBestMin = 0, atkBestMax = 0, atkGKO = false;
                if (forward && Array.isArray(forward.perMove)) {
                    forward.perMove.forEach(function(m) {
                        if (m.maxPercent >= atkBestMax) { atkBestMax = m.maxPercent||0; atkBestMin = m.minPercent||0; atkBestMove = m.move; }
                        if (m.guaranteedKO) atkGKO = true;
                    });
                }
                var defBestMove = '', defBestMin = 0, defBestMax = 0;
                if (reverse && Array.isArray(reverse.perMove)) {
                    reverse.perMove.forEach(function(m) {
                        if (m.maxPercent >= defBestMax) { defBestMax = m.maxPercent; defBestMin = m.minPercent; defBestMove = m.move; }
                    });
                }
                var atkSpeed = atk.rawStats ? atk.rawStats.sp : 0;
                var defSpeed = def.rawStats ? def.rawStats.sp : 0;
                if (atk.boosts && atk.boosts.sp) atkSpeed = getModifiedStat(atkSpeed, atk.boosts.sp);
                if (def.boosts && def.boosts.sp) defSpeed = getModifiedStat(defSpeed, def.boosts.sp);
                var outspeeds = atkSpeed > defSpeed;
                var memberScore = defBestMax - atkBestMax + (outspeeds ? -40 : 0) + (atkGKO ? -200 : 0);
                members.push({
                    attackerBestMove: atkBestMove, attackerBestMin: atkBestMin, attackerBestMax: atkBestMax,
                    attackerGuaranteedKO: atkGKO,
                    defenderBestMove: defBestMove, defenderBestMin: defBestMin, defenderBestMax: defBestMax,
                    outspeeds: outspeeds, score: memberScore
                });
            }
            r.members = members;
            r.score = Math.min.apply(null, members.map(function(m){ return m.score; }));
        }

        

        /* ==== helpers ==== */
        function formatEvs(evs) {
            if (!evs) return '';
            var lbl = {hp:'HP',at:'Atk',df:'Def',sa:'SpA',sd:'SpD',sp:'Spe'};
            var parts = [];
            ['hp','at','df','sa','sd','sp'].forEach(function(k) { if (evs[k]) parts.push(evs[k]+' '+lbl[k]); });
            return parts.length ? parts.join('/') : '0';
        }
        /* ==== item sprite path helper ==== */
        function getItemSpritePath(itemName) {
            if (!itemName) return null;
            var name = itemName.trim();
            // Special case: file uses a space instead of hyphen
            var special = { 'Lax Incense': 'lax incense' };
            if (special[name]) return 'Sprites/Items/' + special[name] + '.png';
            // Berry items: strip " Berry", lowercase
            if (name.indexOf(' Berry') === name.length - 6 && name.length > 6) {
                return 'Sprites/Items/' + name.replace(' Berry', '').toLowerCase() + '.png';
            }
            // General: lowercase, remove apostrophes, replace spaces with hyphens
            return 'Sprites/Items/' + name.toLowerCase().replace(/'/g, '').replace(/\s+/g, '-') + '.png';
        }

        function renderMoveLabel(moveName) {
            if (!moveName) return $('<span>').text('-');
            var mvGlobal = (typeof moves !== 'undefined') ? moves : (typeof MOVES_ADV !== 'undefined' ? MOVES_ADV : {});
            var type = (mvGlobal[moveName] && mvGlobal[moveName].type) ? mvGlobal[moveName].type.toLowerCase() : 'normal';
            return $('<span>').addClass('move-label type-' + type.replace(/[^a-z0-9]+/g,'')).text(moveName);
        }
        function renderEvs(evs) {
            var order = ['hp','at','df','sa','sd','sp'];
            var labels = {hp:'HP',at:'Atk',df:'Def',sa:'SpA',sd:'SpD',sp:'Spe'};
            var td = $('<td>');
            var grid = $('<div>').addClass('ev-grid');
            order.forEach(function(k){
                var v = (evs && evs[k]) ? evs[k] : '-';
                var cell = $('<div>').addClass('ev-cell');
                cell.append($('<span>').addClass('value').text(v));
                cell.append($('<span>').addClass('label').text(labels[k]));
                grid.append(cell);
            });
            td.append(grid);
            return td;
        }

        /* ==== national dex sprite helpers ==== */
        function normalizeNameForKey(s) { return (s||'').toString().toLowerCase().replace(/[^a-z0-9]+/g,''); }
        function pad4(n) { return (''+n).padStart(4, '0'); }
        function buildNationalMap() {
            if (window.__nationalMap) return window.__nationalMap;
            var map = {};
            var arr = (typeof SPECIES_NATIONAL !== 'undefined') ? SPECIES_NATIONAL : (typeof window.SPECIES_NATIONAL !== 'undefined' ? window.SPECIES_NATIONAL : null);
            if (arr && Array.isArray(arr)) arr.forEach(function(p){ if (p && p.length>=2) map[normalizeNameForKey(p[1])] = p[0]; });
            window.__nationalMap = map;
            return map;
        }
        function getNationalNumber(species) { var m = buildNationalMap(); return m[normalizeNameForKey(species)] || null; }

        /* ==== team card management ==== */
        function createTeamCard(idx) {
            var card = $('<div>').addClass('team-card').attr('data-idx', idx);
            // top row: card number + import + remove
            var topRow = $('<div>').addClass('tc-top-row');
            topRow.append($('<span>').addClass('card-num').text('#' + (idx+1)));
            var importBtn = $('<button>').addClass('import-btn').text('Import').click(function(){ showImportDialog(card); });
            topRow.append(importBtn);
            card.append(topRow);
            // species input with custom autocomplete
            var sp = $('<input>').addClass('tc-species').attr({'type':'text','autocomplete':'off'});
            var spImg = $('<img>').addClass('tc-sprite').hide();
            var spDropdown = $('<div>').addClass('sp-dropdown');
            var spWrap = $('<div>').addClass('tc-species-wrap').append(spImg).append(sp).append(spDropdown);
            card.append($('<label>').text('Species ').append(spWrap));

            var hlIndex = -1; // highlighted index in dropdown
            function buildDropdownItems(query) {
                var list = window.__speciesList || [];
                var q = (query || '').toLowerCase().trim();
                var filtered;
                if (!q) {
                    filtered = list.slice(0, 30);
                } else {
                    // prefix matches first, then substring matches
                    var prefix = [], sub = [];
                    list.forEach(function(s){
                        var sl = s.toLowerCase();
                        if (sl.indexOf(q) === 0) prefix.push(s);
                        else if (sl.indexOf(q) > 0) sub.push(s);
                    });
                    filtered = prefix.concat(sub).slice(0, 40);
                }
                spDropdown.empty();
                hlIndex = -1;
                filtered.forEach(function(s, i){
                    var opt = $('<div>').addClass('sp-opt').attr('data-val', s).text(s);
                    opt.on('mousedown', function(e){
                        e.preventDefault(); // prevent blur
                        sp.val(s).trigger('change');
                        spDropdown.removeClass('open');
                    });
                    spDropdown.append(opt);
                });
                if (filtered.length) spDropdown.addClass('open');
                else spDropdown.removeClass('open');
            }

            sp.on('input', function(){
                buildDropdownItems($(this).val());
            });
            sp.on('focus', function(){
                buildDropdownItems($(this).val());
            });
            sp.on('blur', function(){
                // small delay so click on dropdown item registers
                setTimeout(function(){ spDropdown.removeClass('open'); }, 150);
            });
            sp.on('keydown', function(e){
                var opts = spDropdown.find('.sp-opt');
                if (!opts.length) return;
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    hlIndex = Math.min(hlIndex + 1, opts.length - 1);
                    opts.removeClass('highlighted');
                    $(opts[hlIndex]).addClass('highlighted');
                    opts[hlIndex].scrollIntoView({block:'nearest'});
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    hlIndex = Math.max(hlIndex - 1, 0);
                    opts.removeClass('highlighted');
                    $(opts[hlIndex]).addClass('highlighted');
                    opts[hlIndex].scrollIntoView({block:'nearest'});
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (hlIndex >= 0 && hlIndex < opts.length) {
                        sp.val($(opts[hlIndex]).attr('data-val')).trigger('change');
                    } else if (opts.length === 1) {
                        sp.val($(opts[0]).attr('data-val')).trigger('change');
                    }
                    spDropdown.removeClass('open');
                } else if (e.key === 'Escape') {
                    spDropdown.removeClass('open');
                }
            });

            // update sprite when species input changes
            sp.on('input change', function(){
                var name = $(this).val();
                var nat = getNationalNumber(name);
                if (nat) {
                    spImg.attr('src','Sprites/'+pad4(nat)+'.png').attr('alt',name).show().off('error').on('error', function(){ $(this).hide(); });
                } else {
                    spImg.hide();
                }
            });
            card.append($('<label>').text('Lvl ').append($('<input>').addClass('tc-level').attr({'type':'number','min':1,'max':100}).val(50).on('change', function(){
                var v = parseInt($(this).val()) || 1; if (v < 1) v = 1; if (v > 100) v = 100; $(this).val(v);
            })));
            card.append($('<label>').text('Nature ').append($('<select>').addClass('tc-nature').html(__natureOpts)));
            var itemSel = $('<select>').addClass('tc-item').css('width','120px').html(__itemOpts);
            var itemImg = $('<img>').addClass('item-sprite').hide();
            var itemWrap = $('<div>').css('display','flex').css('align-items','center').append(itemImg).append(itemSel);
            card.append($('<label>').text('Item ').append(itemWrap));
            // update item sprite on change
            itemSel.change(function(){
                var it = $(this).val();
                var p = getItemSpritePath(it);
                if (p) itemImg.attr('src', p).show().off('error').on('error', function(){ $(this).hide(); });
                else itemImg.hide();
            });
            var abilSel = $('<select>').addClass('tc-ability').css('width','110px').html('<option value="">(None)</option>');
            card.append($('<label>').text('Ability ').append(abilSel));
            // update ability dropdown when species changes
            sp.on('change.ability input.ability', function(){
                var specName = $(this).val();
                var pdx = (typeof pokedex !== 'undefined') ? pokedex : (typeof POKEDEX_ADV !== 'undefined' ? POKEDEX_ADV : {});
                var entry = pdx[specName];
                var abilities = (entry && entry.abilities) ? entry.abilities : [];
                var html = '';
                abilities.forEach(function(a){ html += '<option value="'+a+'">'+a+'</option>'; });
                if (!abilities.length) html = '<option value="">(None)</option>';
                abilSel.html(html);
            });
            // stat grid: header row, EV row, IV row
            var statKeys = ['hp','at','df','sa','sd','sp'];
            var statLabels = {hp: 'HP', at: 'Atk', df: 'Def', sa: 'SpA', sd: 'SpD', sp: 'Spe'};
            var sgrid = $('<div>').addClass('stat-grid');
            // header row
            sgrid.append($('<div>')); // empty top-left corner
            statKeys.forEach(function(k){ sgrid.append($('<div>').addClass('sg-label').text(statLabels[k])); });
            // EV row
            sgrid.append($('<div>').addClass('sg-row-label').text('EVs'));
            var evInputs = {};
            statKeys.forEach(function(k){
                var inp = $('<input>').addClass('tc-ev-'+k).attr({'type':'number','min':0,'max':255}).val(0);
                inp.on('change', function(){
                    var v = parseInt($(this).val()) || 0; if (v < 0) v = 0; if (v > 255) v = 255; $(this).val(v);
                    var sum = 0;
                    sgrid.find('.tc-ev-hp,.tc-ev-at,.tc-ev-df,.tc-ev-sa,.tc-ev-sd,.tc-ev-sp').each(function(){ sum += parseInt($(this).val()) || 0; });
                    if (sum > 510) { var excess = sum - 510; $(this).val(Math.max(0, v - excess)); }
                });
                evInputs[k] = inp;
                sgrid.append($('<div>').append(inp));
            });
            // IV row
            sgrid.append($('<div>').addClass('sg-row-label').text('IVs'));
            statKeys.forEach(function(k){
                var inp = $('<input>').addClass('tc-iv-'+k).attr({'type':'number','min':0,'max':31}).val(31);
                inp.on('change', function(){
                    var v = parseInt($(this).val()) || 0; if (v < 0) v = 0; if (v > 31) v = 31; $(this).val(v);
                });
                sgrid.append($('<div>').append(inp));
            });
            card.append(sgrid);
            // stat boost selectors (stages -6 to +6)
            var boostGroup = $('<div>').addClass('boost-group');
            var boostOpts = '';
            for (var b = -6; b <= 6; b++) { boostOpts += '<option value="'+b+'"'+(b===0?' selected':'')+'>'+( b>0?'+':'')+b+'</option>'; }
            var boostKeys = ['at','df','sa','sd','sp'];
            var boostLabels = {at: 'Atk', df: 'Def', sa: 'SpA', sd: 'SpD', sp: 'Spe'};
            boostKeys.forEach(function(k){
                boostGroup.append($('<label>').text(boostLabels[k]).append($('<select>').addClass('tc-boost-'+k).html(boostOpts)));
            });
            card.append(boostGroup);
            for (var i = 1; i <= 4; i++) {
                card.append($('<label>').text('Move ' + i + ' ').append($('<select>').addClass('tc-move tc-move'+i).html(__moveOpts).css('width','120px')));
            }
            // filter move dropdowns when species changes
            sp.on('change.moves input.moves', function(){
                var specName = $(this).val();
                var allowed = (typeof LEARNSETS !== 'undefined' && LEARNSETS[specName]) ? LEARNSETS[specName] : null;
                card.find('.tc-move').each(function(){
                    var sel = $(this);
                    var cur = sel.val();
                    if (allowed) {
                        var html = '<option value="">(No Move)</option>';
                        allowed.forEach(function(m){
                            if (m === 'Hidden Power') {
                                HP_TYPES.forEach(function(t){ html += '<option value="Hidden Power '+t+'">Hidden Power '+t+'</option>'; });
                            } else {
                                html += '<option value="'+m+'">'+m+'</option>';
                            }
                        });
                        sel.html(html);
                        // restore previous value if still valid
                        if (cur && sel.find('option[value="'+cur.replace(/"/g,'\\"')+'"]').length) sel.val(cur);
                        else sel.val('');
                    } else {
                        sel.html(__moveOpts);
                        sel.val(cur || '');
                    }
                });
            });
            // auto-set IVs when a Hidden Power type is selected
            card.find('.tc-move').on('change', function(){
                var val = $(this).val() || '';
                var hpMatch = val.match(/^Hidden Power (.+)$/);
                if (hpMatch && HP_TYPE_IVS[hpMatch[1]]) {
                    var spread = HP_TYPE_IVS[hpMatch[1]];
                    ['hp','at','df','sa','sd','sp'].forEach(function(k){
                        card.find('.tc-iv-'+k).val(spread[k]);
                    });
                    card.find('.tc-level').trigger('change'); // refresh HP display
                }
            });
            // status condition
            var statusOpts = '<option value="Healthy">Healthy</option><option value="Burned">Burned</option><option value="Paralyzed">Paralyzed</option><option value="Poisoned">Poisoned</option><option value="Badly Poisoned">Badly Poisoned</option><option value="Asleep">Asleep</option><option value="Frozen">Frozen</option>';
            card.append($('<label>').text('Status ').append($('<select>').addClass('tc-status').html(statusOpts)));
            // current HP input + display (Current HP: <input>/max (xx%))
            var curHpInp = $('<input>').addClass('tc-curhp').attr({'type':'number','min':0}).css('width','80px');
            var hpDisp = $('<span>').addClass('tc-hp-display').css({'margin-left':'6px','font-weight':'bold','display':'inline-block','transform':'translateY(3px)'}).text('/? (100%)');
            var hpWrap = $('<div>').addClass('tc-hp-wrap').append($('<label>').text('Current HP ').append(curHpInp)).append(hpDisp).css({'display':'inline-flex','align-items':'center','gap':'6px'});
            card.append(hpWrap);

            // helper to update max HP and percentage display
            function updateHPDisplay() {
                var specName = sp.val();
                var lv = parseInt(card.find('.tc-level').val()) || 50;
                var ivsObj = {};
                ['hp','at','df','sa','sd','sp'].forEach(function(k){ ivsObj[k] = parseInt(card.find('.tc-iv-'+k).val()); if (isNaN(ivsObj[k])) ivsObj[k] = 31; });
                var evsObj = {};
                ['hp','at','df','sa','sd','sp'].forEach(function(k){ evsObj[k] = parseInt(card.find('.tc-ev-'+k).val()) || 0; });
                var nat = card.find('.tc-nature').val() || 'Hardy';
                // build a temporary poke to compute maxHP using buildPoke
                try {
                        var tmp = buildPoke({species: specName, level: lv, ivs: ivsObj, evs: evsObj, nature: nat});
                        var max = tmp.maxHP || 1;
                        var cur = parseInt(curHpInp.val());
                        if (isNaN(cur) || cur === null) cur = max;
                        if (cur > max) cur = max;
                        curHpInp.val(cur);
                        var pct = 0;
                        if (cur > 0) pct = Math.max(1, Math.round(100 * cur / max));
                        hpDisp.text('/' + max + ' (' + pct + '%)');
                        curHpInp.attr('max', max);
                } catch (e) {
                    // buildPoke may not be available yet; fallback
                    hpDisp.text('/? (100%)');
                }
            }

            // attach update handlers to inputs that affect max HP or current HP
            sp.on('input change', updateHPDisplay);
            // when species changes (select/change), set current HP to full
            sp.on('change', function(){
                try { updateHPDisplay(); } catch(e) {}
                var max = parseInt(curHpInp.attr('max')) || null;
                if (max) {
                    curHpInp.val(max);
                    try { updateHPDisplay(); } catch(e) {}
                }
            });
            card.find('.tc-level').on('change input', updateHPDisplay);
            card.find('.tc-iv-hp,.tc-iv-at,.tc-iv-df,.tc-iv-sa,.tc-iv-sd,.tc-iv-sp').on('change input', updateHPDisplay);
            card.find('.tc-ev-hp,.tc-ev-at,.tc-ev-df,.tc-ev-sa,.tc-ev-sd,.tc-ev-sp').on('change input', updateHPDisplay);
            card.find('.tc-nature').on('change', updateHPDisplay);
            curHpInp.on('change input', updateHPDisplay);
            if (idx > 0) {
                topRow.append($('<button>').addClass('remove-btn').text('\u2715').click(function(){ card.remove(); renumberCards(); }));
            }
            return card;
        }
        /* ==== Showdown import dialog & parser ==== */
        function showImportDialog(card) {
            var overlay = $('<div>').addClass('import-overlay');
            var dialog = $('<div>').addClass('import-dialog');
            dialog.append($('<h3>').text('Import Pok\u00E9mon Set'));
            var ta = $('<textarea>').attr('placeholder','Linoone @ Choice Band\nAbility: Pickup\nEVs: 252 Atk / 4 Def / 252 Spe\nAdamant Nature\n- Trick\n- Belly Drum\n- Extreme Speed\n- Shadow Ball');
            dialog.append(ta);
            var btnRow = $('<div>').addClass('btn-row');
            btnRow.append($('<button>').addClass('import-cancel').text('Cancel').click(function(){ overlay.remove(); }));
            btnRow.append($('<button>').addClass('import-ok').text('Import').click(function(){
                parseAndApplySet(card, ta.val());
                overlay.remove();
            }));
            dialog.append(btnRow);
            overlay.append(dialog);
            overlay.click(function(e){ if (e.target === overlay[0]) overlay.remove(); });
            $('body').append(overlay);
            ta.focus();
        }

        function parseAndApplySet(card, text) {
            if (!text || !text.trim()) return;
            var lines = text.trim().split('\n').map(function(l){ return l.trim(); }).filter(function(l){ return l.length > 0; });
            if (!lines.length) return;

            // Line 1: Species @ Item  OR  Nickname (Species) @ Item
            var line1 = lines[0];
            var species = '', item = '';
            var atIdx = line1.lastIndexOf(' @ ');
            if (atIdx !== -1) {
                item = line1.substring(atIdx + 3).trim();
                var left = line1.substring(0, atIdx).trim();
                // check for (Species) pattern
                var parenMatch = left.match(/\(([^)]+)\)/);
                species = parenMatch ? parenMatch[1].trim() : left;
            } else {
                var parenMatch2 = line1.match(/\(([^)]+)\)/);
                species = parenMatch2 ? parenMatch2[1].trim() : line1.trim();
            }

            var ability = '', nature = '';
            var evs = {hp:0,at:0,df:0,sa:0,sd:0,sp:0};
            var ivs = {hp:31,at:31,df:31,sa:31,sd:31,sp:31};
            var movesList = [];
            var level = null;

            var statMap = {'HP':'hp','Atk':'at','Def':'df','SpA':'sa','SpD':'sd','Spe':'sp','Spd':'sp','Speed':'sp','Attack':'at','Defense':'df','Sp.Atk':'sa','Sp.Def':'sd'};

            for (var i = 1; i < lines.length; i++) {
                var ln = lines[i];
                if (ln.indexOf('Ability:') === 0) {
                    ability = ln.substring(8).trim();
                } else if (ln.indexOf('Level:') === 0) {
                    level = parseInt(ln.substring(6).trim()) || null;
                } else if (ln.indexOf('EVs:') === 0) {
                    var evParts = ln.substring(4).split('/');
                    evParts.forEach(function(p){
                        p = p.trim();
                        var m = p.match(/^(\d+)\s+(.+)$/);
                        if (m) {
                            var val = parseInt(m[1]);
                            var key = statMap[m[2].trim()];
                            if (key) evs[key] = val;
                        }
                    });
                } else if (ln.indexOf('IVs:') === 0) {
                    var ivParts = ln.substring(4).split('/');
                    ivParts.forEach(function(p){
                        p = p.trim();
                        var m = p.match(/^(\d+)\s+(.+)$/);
                        if (m) {
                            var val = parseInt(m[1]);
                            var key = statMap[m[2].trim()];
                            if (key) ivs[key] = val;
                        }
                    });
                } else if (ln.match(/Nature$/i)) {
                    nature = ln.replace(/\s*Nature$/i, '').trim();
                } else if (ln.indexOf('- ') === 0) {
                    var mv = ln.substring(2).trim();
                    // normalize Hidden Power formats like "Hidden Power [Bug]" to "Hidden Power Bug"
                    var hpBracket = mv.match(/^Hidden Power\s*\[\s*([^\]]+)\s*\]$/i);
                    if (hpBracket) {
                        var t = hpBracket[1].trim();
                        t = t.charAt(0).toUpperCase() + t.slice(1).toLowerCase();
                        mv = 'Hidden Power ' + t;
                    }
                    // also normalize parentheses form "Hidden Power (Bug)"
                    var hpParen = mv.match(/^Hidden Power\s*\(\s*([^\)]+)\s*\)$/i);
                    if (hpParen) {
                        var t2 = hpParen[1].trim();
                        t2 = t2.charAt(0).toUpperCase() + t2.slice(1).toLowerCase();
                        mv = 'Hidden Power ' + t2;
                    }
                    movesList.push(mv);
                }
            }

            // If imported moves include a Hidden Power type, use that to set IVs
            var hpFound = null;
            movesList.forEach(function(mv){
                var hm = mv.match(/^Hidden Power\s+([A-Za-z]+)$/i);
                if (hm) {
                    var t = hm[1].trim();
                    t = t.charAt(0).toUpperCase() + t.slice(1).toLowerCase();
                    if (HP_TYPE_IVS[t]) hpFound = t;
                }
            });
            if (hpFound) {
                ivs = {};
                ['hp','at','df','sa','sd','sp'].forEach(function(k){ ivs[k] = HP_TYPE_IVS[hpFound][k]; });
            }

            // Apply to card
            var sp = card.find('.tc-species');
            sp.val(species).trigger('change');

            if (level !== null) card.find('.tc-level').val(level);
            if (item) {
                card.find('.tc-item').val(item).trigger('change');
            }
            if (nature) card.find('.tc-nature').val(nature);
            if (ability) {
                // wait a tick for ability dropdown to populate from species change
                setTimeout(function(){
                    card.find('.tc-ability').val(ability);
                }, 50);
            }
            ['hp','at','df','sa','sd','sp'].forEach(function(k){
                card.find('.tc-iv-'+k).val(ivs[k]);
                card.find('.tc-ev-'+k).val(evs[k]);
            });
            // set moves (wait a tick for move dropdowns to populate from species change)
            setTimeout(function(){
                for (var mi = 0; mi < 4; mi++) {
                    var sel = card.find('.tc-move'+(mi+1));
                    if (mi < movesList.length) sel.val(movesList[mi]);
                    else sel.val('');
                }
                // trigger HP update
                card.find('.tc-level').trigger('change');
            }, 100);
        }

        function renumberCards() {
            $('#teamContainer .team-card').each(function(i) {
                $(this).attr('data-idx', i).find('.card-num').text('#' + (i+1));
                if (i === 0) $(this).find('.remove-btn').hide(); else $(this).find('.remove-btn').show();
            });
        }

        /* ==== build team from form ==== */
        function buildTeamFromForm() {
            var team = [];
            $('#teamContainer .team-card').each(function(){
                var $c = $(this);
                var sp = $c.find('.tc-species').val();
                if (!sp) return;
                var lv = parseInt($c.find('.tc-level').val()) || 50;
                if (lv < 1) lv = 1; if (lv > 100) lv = 100;
                var nat = $c.find('.tc-nature').val();
                var item = $c.find('.tc-item').val();
                var ability = $c.find('.tc-ability').val();
                var ivs = {};
                ['hp','at','df','sa','sd','sp'].forEach(function(k){ ivs[k] = parseInt($c.find('.tc-iv-'+k).val()); if (isNaN(ivs[k])) ivs[k] = 31; if (ivs[k] < 0) ivs[k] = 0; if (ivs[k] > 31) ivs[k] = 31; });
                var evs = {};
                ['hp','at','df','sa','sd','sp'].forEach(function(k){ evs[k] = parseInt($c.find('.tc-ev-'+k).val()) || 0; if (evs[k] < 0) evs[k] = 0; if (evs[k] > 255) evs[k] = 255; });
                // enforce total EV limit 510 by reducing from last stats if necessary
                var totalEvs = Object.keys(evs).reduce(function(acc,kk){ return acc + (evs[kk]||0); }, 0);
                if (totalEvs > 510) {
                    var order = ['sp','sd','sa','df','at','hp'];
                    var excess = totalEvs - 510;
                    for (var oi = 0; oi < order.length && excess > 0; oi++) {
                        var k = order[oi];
                        var reduce = Math.min(evs[k], excess);
                        evs[k] -= reduce;
                        excess -= reduce;
                    }
                }
                var boosts = {};
                ['at','df','sa','sd','sp'].forEach(function(k){ boosts[k] = parseInt($c.find('.tc-boost-'+k).val()) || 0; });
                var mvs = [];
                for (var i = 1; i <= 4; i++) { var v = $c.find('.tc-move'+i).val(); if (v) mvs.push(v); }
                var status = $c.find('.tc-status').val() || 'Healthy';
                var curHpVal = $c.find('.tc-curhp').val();
                var teamEntry = {species:sp, level:lv, nature:nat, item:item, ability:ability, evs:evs, ivs:ivs, moves:mvs, boosts:boosts, status:status};
                if (curHpVal !== undefined && curHpVal !== '') teamEntry.curHP = Number(curHpVal);
                team.push(teamEntry);
            });
            return team;
        }

        /* ==== pool / name filters ==== */
        /* ==== build field objects from UI ==== */
        function buildFieldsFromUI() {
            var weather = $('#weatherSelect').val() || '';
            var teamReflect = $('#teamReflect').is(':checked');
            var teamLightScreen = $('#teamLightScreen').is(':checked');
            var oppReflect = $('#oppReflect').is(':checked');
            var oppLightScreen = $('#oppLightScreen').is(':checked');
            // forward field: team attacks opponent ‚Üí defender side has opponent's screens
            var fieldForward = defaultField({weather: weather, isReflect: oppReflect, isLightScreen: oppLightScreen});
            // reverse field: opponent attacks team ‚Üí defender side has team's screens
            var fieldReverse = defaultField({weather: weather, isReflect: teamReflect, isLightScreen: teamLightScreen});
            return {fieldForward: fieldForward, fieldReverse: fieldReverse, weather: weather};
        }

        /* ==== Frontier Brain grouping sort ==== */
        function sortFrontierBrains(list) {
            var brainOrder = ['Greta','Tucker','Lucy','Spenser','Brandon','Anabel'];
            var brainIdx = {}; brainOrder.forEach(function(n,i){ brainIdx[n] = i; });
            var tierOrder = { 'Silver': 0, 'Gold': 1 };
            var brainPattern = /\b(Anabel|Tucker|Greta|Lucy|Brandon|Spenser)\s+(Silver|Gold)\b/i;
            return list.slice().sort(function(a,b){
                var ma = a.setName.match(brainPattern);
                var mb = b.setName.match(brainPattern);
                if (!ma && !mb) return 0;
                if (!ma) return 1;
                if (!mb) return -1;
                var brainA = brainIdx[ma[1]] != null ? brainIdx[ma[1]] : 99;
                var brainB = brainIdx[mb[1]] != null ? brainIdx[mb[1]] : 99;
                if (brainA !== brainB) return brainA - brainB;
                var tierA = tierOrder[ma[2]] != null ? tierOrder[ma[2]] : 2;
                var tierB = tierOrder[mb[2]] != null ? tierOrder[mb[2]] : 2;
                if (tierA !== tierB) return tierA - tierB;
                return a.species.localeCompare(b.species);
            });
        }

        function applyPoolFilter(list) {
            var pool = $('#poolFilter').val();
            if (!pool || pool === 'all') return list;
            if (pool === 'frontier_brains') {
                var brainPattern = /\b(Anabel|Tucker|Greta|Lucy|Brandon|Spenser)\s+(Silver|Gold)\b/i;
                return list.filter(function(r){ return brainPattern.test(r.setName); });
            }
            var groups = {
                'group1': (typeof GROUP1 !== 'undefined') ? GROUP1 : null,
                'group2': (typeof GROUP2 !== 'undefined') ? GROUP2 : null,
                'group3': (typeof GROUP3 !== 'undefined') ? GROUP3 : null
            };
            var arr = groups[pool];
            if (arr && Array.isArray(arr)) {
                var s = {}; arr.forEach(function(n){ s[n] = true; });
                return list.filter(function(r){ return s[r.species]; });
            }
            return list;
        }
        function applyNameFilter(list) {
            var q = $('#nameFilter').val().toLowerCase().trim();
            if (!q) return list;
            return list.filter(function(r){ return (r.species+' '+r.setName).toLowerCase().indexOf(q) !== -1; });
        }

        /* ==== sorting ==== */
        var currentSortCol = 'score', currentSortDir = 'desc';
        function sortList(list, col, dir) {
            return list.slice().sort(function(a,b){
                var va, vb;
                switch(col) {
                    case 'species': va=a.species; vb=b.species; break;
                    case 'set': va=a.setName; vb=b.setName; break;
                    case 'item': va=a.set.item||''; vb=b.set.item||''; break;
                    case 'nature': va=a.set.nature||''; vb=b.set.nature||''; break;
                    default:
                        // check for p<n>atk / p<n>def columns
                        var pm = col.match(/^p(\d+)(atk|def)$/);
                        if (pm) {
                            var mi = parseInt(pm[1])-1;
                            if (pm[2]==='atk') { va=(a.members[mi]?a.members[mi].attackerBestMax:0); vb=(b.members[mi]?b.members[mi].attackerBestMax:0); }
                            else { va=(a.members[mi]?a.members[mi].defenderBestMax:0); vb=(b.members[mi]?b.members[mi].defenderBestMax:0); }
                            return dir==='asc'? va-vb : vb-va;
                        }
                        va=a.score; vb=b.score; return dir==='asc'? va-vb : vb-va;
                }
                var cmp = String(va).localeCompare(String(vb));
                return dir === 'asc' ? cmp : -cmp;
            });
        }

        /* ==== build table headers ==== */
        function buildHeaders(teamSize) {
            var tr = $('#results thead tr');
            tr.empty();
            function th(col, txt) { return $('<th>').attr('data-col',col).html(txt+'<span class="arrow"></span>'); }
            tr.append(th('species',''));
            tr.append(th('set','Set'));
            tr.append(th('item','Item'));
            tr.append(th('nature','Nat'));
            tr.append(th('ability','Ability'));
            tr.append(th('evs','EVs'));
            tr.append($('<th>').text('Moves'));
            for (var i = 0; i < teamSize; i++) {
                var lbl = '#' + (i+1);
                // try to get species name for label
                var $card = $('#teamContainer .team-card').eq(i);
                if ($card.length) {
                    var sn = $card.find('.tc-species').val();
                    if (sn) {
                        var nat = getNationalNumber(sn);
                        if (nat) lbl = '<img src="Sprites/' + pad4(nat) + '.png" style="width:20px;height:20px;vertical-align:middle" alt="' + sn + '">';
                        else lbl = sn.substring(0,6);
                    }
                }
                tr.append(th('p'+(i+1)+'atk', '<b>Dmg Done</b> ' + lbl + '\u2192'));
                tr.append(th('p'+(i+1)+'def', '\u2192' + lbl + ' <b>Dmg Taken</b>'));
            }
            // re-bind header clicks
            tr.find('th[data-col]').off('click').on('click', function(){
                var col = $(this).data('col');
                if (!col) return;
                if (currentSortCol === col) currentSortDir = currentSortDir==='asc'?'desc':'asc';
                else { currentSortCol = col; currentSortDir = 'asc'; }
                renderResults(window.__lastResults || []);
            });
        }

        /* ==== render results ==== */
        function renderResults(list) {
            var tbody = $('#results tbody');
            tbody.empty();
            var teamSize = window.__teamSize || 1;
            buildHeaders(teamSize);

            var filtered = applyPoolFilter(list);
            filtered = applyNameFilter(filtered);

            // When Frontier Brains pool is selected, default sort groups by trainer (Silver then Gold)
            var pool = $('#poolFilter').val();
            if (pool === 'frontier_brains' && currentSortCol === 'score') {
                filtered = sortFrontierBrains(filtered);
            } else {
                filtered = sortList(filtered, currentSortCol, currentSortDir);
            }

            // apply click-to-filter (matching sets sorted to top)
            filtered = applyClickFilters(filtered);

            // update arrows
            $('#results th').each(function(){
                var col = $(this).data('col');
                var arrow = $(this).find('.arrow');
                if (col === currentSortCol) arrow.text(currentSortDir==='asc'?' \u25B2':' \u25BC');
                else arrow.text('');
            });

            filtered.forEach(function(r) {
                var tr = $('<tr>');
                // sprite
                (function(){
                    var nat = getNationalNumber(r.species);
                    if (nat) {
                        var img = $('<img>').addClass('sprite').attr('src','Sprites/'+pad4(nat)+'.png').attr('alt',r.species)
                            .on('error',function(){ $(this).replaceWith($('<span>').text(r.species)); });
                        tr.append($('<td>').append(img));
                    } else tr.append($('<td>').text(r.species));
                })();
                tr.append($('<td>').text(r.setName));
                // item cell with sprite (clickable)
                (function(){
                    var itemTd = $('<td>').addClass('clickable-item');
                    var itemName = r.set.item || '';
                    if (itemName) {
                        var spritePath = getItemSpritePath(itemName);
                        if (spritePath) {
                            var itemImg = $('<img>').addClass('item-sprite')
                                .attr('src', spritePath).attr('alt', itemName)
                                .on('error', function(){ $(this).hide(); });
                            itemTd.append(itemImg);
                        }
                        if (__clickFilters.item === itemName) itemTd.addClass('filter-active');
                        itemTd.click(function(){ toggleClickFilter('item', itemName); });
                    }
                    var nameSpan = $('<span>').text(itemName);
                    itemTd.append(nameSpan);
                    
                    tr.append(itemTd);
                })();
                // nature cell (clickable)
                (function(){
                    var natName = r.set.nature || '';
                    var natTd = $('<td>').addClass('clickable-nature').text(natName);
                    if (natName) {
                        if (__clickFilters.nature === natName) natTd.addClass('filter-active');
                        natTd.click(function(){ toggleClickFilter('nature', natName); });
                    }
                    tr.append(natTd);
                })();
                // ability cell
                (function(){
                    var pdx = (typeof pokedex !== 'undefined') ? pokedex : (typeof POKEDEX_ADV !== 'undefined' ? POKEDEX_ADV : {});
                    var entry = pdx[r.species];
                    var abilities = (entry && entry.abilities) ? entry.abilities : [];
                    var abilTd = $('<td>');
                    if (abilities.length === 1) {
                        var lbl = $('<span>').addClass('ability-label').text(abilities[0]);
                        if (__abilityDescriptions[abilities[0]]) lbl.append($('<span>').addClass('ability-tip').text(__abilityDescriptions[abilities[0]]));
                        abilTd.append(lbl);
                        // store chosen ability on result for damage calc
                        r.__chosenAbility = abilities[0];
                    } else if (abilities.length === 2) {
                        // two abilities: clickable to select which to compute against
                        var chosen = r.__chosenAbility || null;
                        abilities.forEach(function(ab, idx){
                            if (idx > 0) abilTd.append($('<span>').addClass('ability-sep').text('/'));
                            var lbl = $('<span>').addClass('ability-label clickable');
                            lbl.text(ab);
                            if (__abilityDescriptions[ab]) lbl.append($('<span>').addClass('ability-tip').text(__abilityDescriptions[ab]));
                            if (chosen === ab) lbl.addClass('ability-active');
                            else if (chosen && chosen !== ab) lbl.addClass('ability-inactive');
                            lbl.click(function(e){
                                e.stopPropagation();
                                if (r.__chosenAbility === ab) r.__chosenAbility = null; // toggle off
                                else r.__chosenAbility = ab;
                                recalcRowWithAbility(r);
                                renderResults(window.__lastResults || []);
                            });
                            abilTd.append(lbl);
                        });
                    }
                    tr.append(abilTd);
                })();
                tr.append(renderEvs(r.set.evs));
                // opponent moves (clickable)
                var movesTd = $('<td>');
                (r.set.moves||[]).forEach(function(moveName){
                    var lbl = renderMoveLabel(moveName);
                    if (__clickFilters.move === moveName) lbl.addClass('filter-active');
                    lbl.click(function(e){ e.stopPropagation(); toggleClickFilter('move', moveName); });
                    movesTd.append(lbl);
                });
                tr.append(movesTd);

                // per-member columns
                for (var mi = 0; mi < teamSize; mi++) {
                    var m = r.members && r.members[mi] ? r.members[mi] : null;
                    if (!m) { tr.append($('<td>').text('-')); tr.append($('<td>').text('-')); continue; }
                    // "member ‚Üí set" cell
                    var atkTd = $('<td>').addClass('dmg-you');
                    var atkWrap = $('<div>').addClass('matchup-cell');
                    atkWrap.append($('<span>').addClass('mc-move').append(renderMoveLabel(m.attackerBestMove)));
                    atkWrap.append($('<span>').addClass('mc-dmg').text(m.attackerBestMin + '-' + m.attackerBestMax + '%'));
                    var spdSpan = $('<span>').addClass('mc-spd');
                    if (m.outspeeds) spdSpan.addClass('fast').text('\u25B2 FASTER');
                    else spdSpan.addClass('slow').text('\u25BC SLOWER');
                    atkWrap.append(spdSpan);
                    atkTd.append(atkWrap);
                    if (m.attackerBestMin >= 100) atkTd.addClass('ohko');
                    else if (m.attackerBestMax >= 100) atkTd.addClass('maybe-ohko');
                    tr.append(atkTd);
                    // "set ‚Üí member" cell
                    var defTd = $('<td>').addClass('dmg-them');
                    var defWrap = $('<div>').addClass('matchup-cell');
                    defWrap.append($('<span>').addClass('mc-move').append(renderMoveLabel(m.defenderBestMove)));
                    defWrap.append($('<span>').addClass('mc-dmg').text(m.defenderBestMin + '-' + m.defenderBestMax + '%'));
                    defTd.append(defWrap);
                    if (m.defenderBestMin >= 100) defTd.addClass('ohko');
                    else if (m.defenderBestMax >= 100) defTd.addClass('maybe-ohko');
                    tr.append(defTd);
                }
                tbody.append(tr);
            });
            $('#status').text(filtered.length + ' sets shown');
        }

        /* ==== init ==== */
        $(function(){
            window.gameId = 3;
            if (typeof setGenProperties === 'function') setGenProperties();

            // cache dropdown option HTML
            var pdx = (typeof pokedex !== 'undefined') ? pokedex : (typeof POKEDEX_ADV !== 'undefined' ? POKEDEX_ADV : {});
            __speciesList = Object.keys(pdx).sort();
            __speciesOpts = __speciesList.map(function(s){ return '<option value="'+s+'">'+s+'</option>'; }).join('');
            var mv = (typeof moves !== 'undefined') ? moves : (typeof MOVES_ADV !== 'undefined' ? MOVES_ADV : {});
            __moveOpts = '<option value="">(No Move)</option>' + Object.keys(mv).sort().map(function(m){ return '<option value="'+m+'">'+m+'</option>'; }).join('');
            __natureOpts = Object.keys(NATURES).map(function(n){ return '<option value="'+n+'">'+n+'</option>'; }).join('');
            // build item options (prefer ADV list if available, fallback to GSC)
            var itemsList = (typeof ITEMS_ADV !== 'undefined') ? ITEMS_ADV : ((typeof ITEMS_GSC !== 'undefined') ? ITEMS_GSC : []);
            var uniq = (itemsList && Array.isArray(itemsList)) ? itemsList.slice().sort() : [];
            __itemOpts = '<option value="">(No Item)</option>' + uniq.map(function(it){ return '<option value="'+it+'">'+it+'</option>'; }).join('');

            // create first team card
            var card0 = createTeamCard(0);
            $('#teamContainer').append(card0);
            card0.find('.tc-species').val('Pikachu').change();
            card0.find('.tc-nature').val('Timid');
            card0.find('.tc-item').val('Light Ball').change();
            // default EVs for first pokemon set to 0
            card0.find('.tc-ev-hp').val(0);
            card0.find('.tc-ev-at').val(0);
            card0.find('.tc-ev-df').val(0);
            card0.find('.tc-ev-sa').val(0);
            card0.find('.tc-ev-sd').val(0);
            card0.find('.tc-ev-sp').val(0);
            card0.find('.tc-move1').val('Thunderbolt');
            card0.find('.tc-move2').val('Quick Attack');

            // + button
            $('#addMember').click(function(){
                var count = $('#teamContainer .team-card').length;
                if (count >= 6) return; // max 6
                var newCard = createTeamCard(count);
                $('#teamContainer').append(newCard);
                renumberCards();
            });

            // toggle oppLevel
            $('#oppAuto').change(function(){ $('#oppLevel').prop('disabled', $(this).is(':checked')); });
            $('#oppLevel').prop('disabled', $('#oppAuto').is(':checked'));

            // calculate
            $('#calc').click(function(){
                var status = $('#status');
                status.text('Calculating...');
                try {
                    var teamInputs = buildTeamFromForm();
                    if (!teamInputs.length) { status.text('Add at least one Pokemon'); return; }
                    var limit = 2000;
                    // determine opp level
                    var maxLevel = Math.max.apply(null, teamInputs.map(function(t){ return t.level||50; }));
                    var oppLevel;
                    if ($('#oppAuto').is(':checked')) oppLevel = Math.max(50, maxLevel);
                    else oppLevel = parseInt($('#oppLevel').val()) || 50;

                    // build team for display
                    var builtTeam = teamInputs.map(function(t){
                        var p = buildPoke(t);
                        if (t.boosts) { ['at','df','sa','sd','sp'].forEach(function(k){ p.boosts[k] = t.boosts[k] || 0; }); }
                        return p;
                    });
                    window.__team = builtTeam;
                    window.__teamSize = builtTeam.length;

                    var fields = buildFieldsFromUI();
                    var list = evaluateAllSetsTeam(builtTeam, {limit: limit, opponentLevel: oppLevel, fieldForward: fields.fieldForward, fieldReverse: fields.fieldReverse});
                    window.__lastResults = list;
                    currentSortCol = 'score';
                    currentSortDir = 'desc';
                    renderResults(list);
                } catch(e) {
                    status.text('Error: ' + e.message);
                    console.error(e);
                }
            });

            // re-render on filter/sort changes
            $('#poolFilter,#nameFilter,#oppAuto,#oppLevel,#weatherSelect,#teamReflect,#teamLightScreen,#oppReflect,#oppLightScreen').on('change input', function(){
                renderResults(window.__lastResults || []);
            });

            // initial calc
            window.__teamSize = 1;
            $('#calc').click();
        });
    </script>
</body>
</html>
